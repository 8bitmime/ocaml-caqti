<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Caqti_request (caqti.Caqti_request)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><meta name="generator" content="doc-ock-html v1.0.0-1-g1fc9bf0"/></head><body><nav id="top"><a href="../index.html">Up</a> &mdash; <span class="package">package <a href="../index.html">caqti</a></span></nav><header><h1><span class="keyword">Module</span> <span class="module-path">Caqti_request</span></h1></header><p>Request specification.</p><p>A Caqti request is a function to generate a query string from information
about the driver, along with type descriptors to encode parameters and
decode rows returned from the same query. Requests are passed to
<a href="../Caqti_connection_sig/module-type-S/index.html#val-call">Caqti_connection_sig.S.call</a> or one of its shortcut methods provided by a
database connection handle.</p><p>The request often represent a prepared query, in which case it is static and
can be be defined directly in a module scope. However, an optional
<code class="code">oneshot</code> parameter may be passed to indicate a dynamically generated
query.</p><h3>Primitives</h3><div class="spec type" id="type-query"><a href="#type-query" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>query</code><code></code><code><span class="keyword"> = </span></code><table class="variant"><tr id="type-query.L" class="anchored"><td class="def constructor"><a href="#type-query.L" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">L</span><span class="keyword"> of </span>string</code></td><td class="doc"><p>(** Literal code. May contain incomplete fragments. *)</p></td></tr><tr id="type-query.P" class="anchored"><td class="def constructor"><a href="#type-query.P" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">P</span><span class="keyword"> of </span>int</code></td><td class="doc"><p>(** <code class="code">P i</code> refers to parameter number <code class="code">i</code>, counting from 0. *)</p></td></tr><tr id="type-query.S" class="anchored"><td class="def constructor"><a href="#type-query.S" class="anchor"></a><code><span class="keyword">| </span></code><code><span class="constructor">S</span><span class="keyword"> of </span><a href="index.html#type-query">query</a> list</code></td><td class="doc"><p>(** <code class="code">S frags</code> is the concatenation of <code class="code">frags</code>. *)</p></td></tr></table><code></code></div><div class="doc"><p>A representation of a query string to send to a database, abstracting over
parameter references and providing nested concatenation to simplify
generation. For databases which only support linear parameters (typically
denoted &quot;<code class="code">?</code>&quot;), the driver will reshuffle, elide, and duplicate parameters
as needed.</p></div></div><div class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><div class="def type"><code><span class="keyword">type </span>('a, 'b, +'m) t</code><code></code><code><span class="keyword"> constraint </span><span class="type-var">'m</span> = [&lt; `Zero | `One | `Many ]</code></div><div class="doc"><p>A request specification embedding a query generator, parameter encoder, and
row decoder.
</p><ul><li><code class="code">'a</code> is the type of the expected parameter bundle.</li><li><code class="code">'b</code> is the type of a returned row.</li><li><code class="code">'m</code> is the possible multiplicities of returned rows.</li></ul></div></div><div class="spec val" id="val-create"><a href="#val-create" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>create : ?&#8288;oneshot:bool <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'m</span> <a href="../Caqti_mult/index.html#type-t">Caqti_mult.t</a> <span class="keyword">&#8209;&gt;</span> (<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-query">query</a>) <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>) <a href="index.html#type-t">t</a></code></div><div class="doc"><p><code class="code">create arg_type row_type row_mult f</code> is a request which takes parameters of
type <code class="code">arg_type</code>, returns rows of type <code class="code">row_type</code> with multiplicity
<code class="code">row_mult</code>, and which sends query strings generated from the query <code class="code">f
    di</code>, where <code class="code">di</code> is the <a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> of the target driver. The
driver is responsible for turning parameter references into a form accepted
by the database, while other differences must be handled by <code class="code">f</code>.</p></div></div><div class="spec val" id="val-param_type"><a href="#val-param_type" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>param_type : (<span class="type-var">'a</span>, <span class="type-var">_</span>, <span class="type-var">_</span>) <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></code></div><div class="doc"><p><code class="code">param_type req</code> is the type of parameter bundles expected by <code class="code">req</code>.</p></div></div><div class="spec val" id="val-row_type"><a href="#val-row_type" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>row_type : (<span class="type-var">_</span>, <span class="type-var">'b</span>, <span class="type-var">_</span>) <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></code></div><div class="doc"><p><code class="code">row_type req</code> is the type of rows returned by <code class="code">req</code>.</p></div></div><div class="spec val" id="val-row_mult"><a href="#val-row_mult" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>row_mult : (<span class="type-var">_</span>, <span class="type-var">_</span>, <span class="type-var">'m</span>) <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'m</span> <a href="../Caqti_mult/index.html#type-t">Caqti_mult.t</a></code></div><div class="doc"><p><code class="code">row_mult req</code> indicates how many rows <code class="code">req</code> may return. This is asserted
when constructing the query.</p></div></div><div class="spec val" id="val-query_id"><a href="#val-query_id" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>query_id : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>) <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> int option</code></div><div class="doc"><p>If <code class="code">req</code> is a prepared query, then <code class="code">query_id req</code> is <code class="code">Some id</code> for some <code class="code">id</code>
which uniquely identifies <code class="code">req</code>, otherwise it is <code class="code">None</code>.</p></div></div><div class="spec val" id="val-query"><a href="#val-query" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>query : (<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>) <a href="index.html#type-t">t</a> <span class="keyword">&#8209;&gt;</span> <a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-query">query</a></code></div><div class="doc"><p><code class="code">query req</code> is the function which generates the query of this request
possibly tailored for the given driver.</p></div></div><h3>Convenience</h3><p>In the following functions, queries are written out as plain strings with
the following syntax, which is parsed by Caqti into a <a href="index.html#type-query">query</a> object before
being passed to drivers.</p><p><b>Parameters</b> are specified as either</p><ul><li><code class="code">&quot;?&quot;</code> for linear substitutions (like Sqlite and MariaDB), or</li><li><code class="code">&quot;$1&quot;</code>, <code class="code">&quot;$2&quot;</code>, ... for non-linear substitutions (like PostgreSQL).</li></ul><p>Mixing the two styles in the same query string is not permitted. Note that
numbering of non-linear parameters is offset by one compared to the <a href="index.html#type-query.P">P</a>
parameters of the query objects defined in the previous section, in order to
be consistent with PostgreSQL conventions.</p><p><b>Static references</b> are references to the <code class="code">?env</code> argument of the functions
below, and thus fixed once the query has been constructed. The query parser
accepts two forms:</p><ul><li><code class="code">&quot;$(&lt;var&gt;)&quot;</code> is substituted by <code class="code">env driver_info &quot;&lt;var&gt;&quot;</code>.</li><li><code class="code">&quot;$.&quot;</code> is a shortcut for <code class="code">&quot;$(.)&quot;</code>.</li></ul><p>These aid in substituting configurable fragments, like database schemas or
table names. The latter form is suggested for qualifying tables, sequences,
etc. with the main database schema. It should expand to a schema name
followed by a dot, so that the empty string can be returned if the database
does not support schemas or no schema is requested by the user.</p><p>Apart from the more generic <a href="index.html#val-create_p">create_p</a>, these function match up with
retrieval functions of <a href="../Caqti_connection_sig/module-type-S/index.html">Caqti_connection_sig.S</a> and <a href="../Caqti_response_sig/module-type-S/index.html">Caqti_response_sig.S</a>
according to the multiplicity parameter of their types.</p><div class="spec val" id="val-create_p"><a href="#val-create_p" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>create_p : ?&#8288;env:(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-query">query</a>) <span class="keyword">&#8209;&gt;</span> ?&#8288;oneshot:bool <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'m</span> <a href="../Caqti_mult/index.html#type-t">Caqti_mult.t</a> <span class="keyword">&#8209;&gt;</span> (<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="keyword">&#8209;&gt;</span> string) <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>) <a href="index.html#type-t">t</a></code></div><div class="doc"><p><code class="code">create_p arg_type row_type row_mult f</code> is a request which takes parameters
of type <code class="code">arg_type</code>, returns rows of type <code class="code">row_type</code> with multiplicity
<code class="code">row_mult</code>, and which sends a query string based on a preliminary form given
by <code class="code">f di</code>, where <code class="code">di</code> is the <a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> of the target driver.
The preliminary query string may contain parameter and static references as
described in the introduction of this section.</p><ul class="at-tag"><li><span class="at-tag parameter">Parameter</span> <span class="module-path">oneshot</span>: For queries generated on-demand or which are otherwise executed only once,
pass <code class="code">true</code> do make the query non-prepared. By default queries are
prepared, which is suitable for requests defined at the module level.</li><li><span class="at-tag parameter">Parameter</span> <span class="module-path">env</span>: <code class="code">env driver_info key</code> shall provide the value to substitute for a
reference to <code class="code">key</code> in the preliminary query string, or raise <code class="code">Not_found</code>
to indicate the reference to <code class="code">key</code> is invalid. <code class="code">Not_found</code> will be
re-raised as <code class="code">Invalid_argument</code> with additional information to help locate
the bug.</li></ul></div></div><div class="spec val" id="val-exec"><a href="#val-exec" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>exec : ?&#8288;env:(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-query">query</a>) <span class="keyword">&#8209;&gt;</span> ?&#8288;oneshot:bool <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'a</span>, unit, [&gt; `Zero ]) <a href="index.html#type-t">t</a></code></div><div class="doc"><p><code class="code">exec_p arg_type s</code> is a shortcut for <code class="code">create_p arg_type Caqti_type.unit
    Caqti_mult.zero (fun _ -&gt; s)</code>.</p></div></div><div class="spec val" id="val-find"><a href="#val-find" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>find : ?&#8288;env:(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-query">query</a>) <span class="keyword">&#8209;&gt;</span> ?&#8288;oneshot:bool <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&gt; `One ]) <a href="index.html#type-t">t</a></code></div><div class="doc"><p><code class="code">find_p arg_type row_type s</code> is a shortcut for <code class="code">create_p arg_type row_type
    Caqti_mult.one (fun _ -&gt; s)</code>.</p></div></div><div class="spec val" id="val-find_opt"><a href="#val-find_opt" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>find_opt : ?&#8288;env:(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-query">query</a>) <span class="keyword">&#8209;&gt;</span> ?&#8288;oneshot:bool <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&gt; `Zero | `One ]) <a href="index.html#type-t">t</a></code></div><div class="doc"><p><code class="code">find_opt_p arg_type row_type s</code> is a shortcut for <code class="code">create_p arg_type
    row_type Caqti_mult.zero_or_one (fun _ -&gt; s)</code>.</p></div></div><div class="spec val" id="val-collect"><a href="#val-collect" class="anchor"></a><div class="def val"><code><span class="keyword">val </span>collect : ?&#8288;env:(<a href="../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> <a href="index.html#type-query">query</a>) <span class="keyword">&#8209;&gt;</span> ?&#8288;oneshot:bool <span class="keyword">&#8209;&gt;</span> <span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> <span class="type-var">'b</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a> <span class="keyword">&#8209;&gt;</span> string <span class="keyword">&#8209;&gt;</span> (<span class="type-var">'a</span>, <span class="type-var">'b</span>, [&gt; `Zero | `One | `Many ]) <a href="index.html#type-t">t</a></code></div><div class="doc"><p><code class="code">collect_p arg_type row_type s</code> is a shortcut for <code class="code">create_p arg_type
    row_type Caqti_mult.many (fun _ -&gt; s)</code>.</p></div></div><h3>How to Dynamically Assemble Queries and Parameters</h3><p>In some cases, queries are constructed dynamically, e.g. when translating an
expression for searching a database into SQL. In such cases the number of
parameters and their types will typically vary, as well. A helper like the
following can be used to existentially pack the parameter types along with
the corresponding parameter values to allow collecing them incrementally:
</p><pre><code class="code">module Dynparam = struct
  type t = Pack : 'a Caqti_type.t * 'a -&gt; t
  let empty = Pack (Caqti_type.unit, ())
  let add t x (Pack (t', x')) = Pack (Caqti_type.tup2 t' t, (x', x))
end</code></pre><p>
Now, given a <code class="code">param : Dynparam.t</code> and a corresponding query string <code class="code">qs</code>, one
can construct a request and execute it:
</p><pre><code class="code">let Dynparam.Pack (pt, pv) = param in
let req = Caqti_request.exec ~oneshot:true pt qs in
C.exec req pv</code></pre><p>
Note that dynamically constructed requests should have <code class="code">~oneshot:true</code>
unless they are memoized. Also note that it is natural to use <a href="index.html#val-create">create</a> for
dynamically constructed queries, since it accepts the easily composible
<a href="index.html#type-query">query</a> type instead of plain strings.</p><p>This scheme can be specialized for particular use cases, including
generation of fragments of the <code class="code">query</code>, which reduces the risk of wrongly
matching up parameters with their uses in the query string.</p></body></html>